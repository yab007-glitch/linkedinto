import React, { useState, useEffect } from 'react';
import { GeneratorForm } from './components/GeneratorForm';
import { LinkedInPreview } from './components/LinkedInPreview';
import { HistorySidebar } from './components/HistorySidebar';
import { ProfileModal } from './components/ProfileModal';
import { AutomationDashboard } from './components/AutomationDashboard';
import { FeedManager } from './components/FeedManager';
import { ScheduledPostsList } from './components/ScheduledPostsList';
import { GeneratedPost, PostConfig, LinkedInProfile } from './types';
import { generateLinkedInPost, refinePost } from './services/huggingfaceService';
import { getStoredProfile, saveProfile, getAccessToken, postToLinkedIn } from './services/linkedinService';

const App: React.FC = () => {
  const [currentPost, setCurrentPost] = useState<GeneratedPost | null>(null);
  const [history, setHistory] = useState<GeneratedPost[]>([]);
  const [isGenerating, setIsGenerating] = useState(false);
  const [isRefining, setIsRefining] = useState(false);
  const [sidebarOpen, setSidebarOpen] = useState(false);
  const [activeTab, setActiveTab] = useState<'generator' | 'automation' | 'feeds' | 'scheduled'>('generator');

  // LinkedIn Auth State
  const [linkedInUser, setLinkedInUser] = useState<LinkedInProfile | null>(null);
  const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
  const [hasToken, setHasToken] = useState(false);

  const API_BASE = 'http://localhost:3001/api';

  // Load history from Backend and profile from LocalStorage on mount
  useEffect(() => {
    // Fetch History from Backend
    const fetchHistory = async () => {
      try {
        const res = await fetch(`${API_BASE}/history`);
        if (res.ok) {
          const data = await res.json();
          setHistory(data);
        }
      } catch (e) {
        console.error("Failed to fetch history from server", e);
        // Fallback or ignore
      }
    };

    fetchHistory();

    const savedProfile = getStoredProfile();
    const token = getAccessToken();
    if (savedProfile) {
      setLinkedInUser(savedProfile);
    }
    setHasToken(!!token);
  }, []);

  const handleGeneration = async (config: PostConfig) => {
    setIsGenerating(true);
    try {
      const content = await generateLinkedInPost(config, linkedInUser);

      const newPost: GeneratedPost = {
        id: Date.now().toString(),
        content,
        config,
        timestamp: Date.now(),
      };

      setCurrentPost(newPost);

      // Save to Backend
      try {
        await fetch(`${API_BASE}/history`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newPost)
        });
        // Update local state after successful save
        setHistory(prev => [newPost, ...prev]);
      } catch (e) {
        console.error("Failed to save post to server", e);
        alert("Generated post, but failed to save to history.");
        // Still show the post
      }

      // Handle Auto-Post
      if (config.autoPost && linkedInUser?.id && hasToken) {
        try {
          await postToLinkedIn(content, linkedInUser.id);
          alert("Auto-posted to LinkedIn successfully!");
        } catch (postError: any) {
          console.error(postError);
          if (postError.message === "This content has already been posted to LinkedIn.") {
            alert("This post is already live on LinkedIn!");
          } else {
            alert(`Generated content, but auto-post failed: ${postError.message || "Unknown error"}`);
          }
        }
      }

    } catch (err) {
      console.error(err);
      alert("Failed to generate content. Please try again.");
    } finally {
      setIsGenerating(false);
    }
  };

  const handleRefine = async (instruction: string) => {
    if (!currentPost) return;

    setIsRefining(true);
    try {
      const refinedContent = await refinePost(currentPost.content, instruction);
      const updatedPost = {
        ...currentPost,
        content: refinedContent,
        timestamp: Date.now() // Update timestamp to bump to top if we saved revisions
      };
      // We don't save revisions to history to keep it clean, just update current view
      setCurrentPost(updatedPost);
    } catch (err) {
      alert("Failed to refine post.");
    } finally {
      setIsRefining(false);
    }
  };

  const handleSelectHistory = (post: GeneratedPost) => {
    setCurrentPost(post);
    if (window.innerWidth < 768) {
      setSidebarOpen(false);
    }
  };

  const handleSaveProfile = (profile: LinkedInProfile) => {
    setLinkedInUser(profile);
    saveProfile(profile);
    setHasToken(!!getAccessToken());
  };

  return (
    <div className="min-h-screen bg-[#f3f2ef] font-sans flex flex-col">
      {/* Navbar */}
      <nav className="bg-white border-b border-gray-200 sticky top-0 z-20">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between h-16">
            <div className="flex items-center">
              <div className="flex-shrink-0 flex items-center gap-2">
                <div className="w-8 h-8 bg-linkedin-blue rounded-md flex items-center justify-center text-white font-bold text-xl">
                  Li
                </div>
                <span className="font-bold text-gray-700 text-lg hidden sm:block">LinkedInto</span>
              </div>
            </div>
            <div className="flex items-center space-x-4">
              {linkedInUser ? (
                <button
                  onClick={() => setIsProfileModalOpen(true)}
                  className="flex items-center space-x-2 bg-white hover:bg-gray-50 px-3 py-1.5 rounded-full border border-gray-200 transition-colors"
                >
                  {linkedInUser.avatarUrl ? (
                    <img src={linkedInUser.avatarUrl} alt="Avatar" className="w-6 h-6 rounded-full object-cover" />
                  ) : (
                    <div className="w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center text-xs font-bold text-linkedin-blue">
                      {linkedInUser.name.charAt(0)}
                    </div>
                  )}
                  <span className="text-sm font-medium text-gray-700 hidden sm:block">{linkedInUser.name}</span>
                </button>
              ) : (
                <button
                  onClick={() => setIsProfileModalOpen(true)}
                  className="hidden sm:inline-flex items-center px-4 py-2 border border-linkedin-blue text-sm font-medium rounded-full text-linkedin-blue bg-white hover:bg-blue-50 focus:outline-none transition-colors"
                >
                  Connect Profile
                </button>
              )}

              <button
                onClick={() => setSidebarOpen(!sidebarOpen)}
                className="p-2 rounded-md text-gray-500 hover:text-gray-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-linkedin-blue lg:hidden"
              >
                <svg className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </nav>

      <div className="flex-1 flex overflow-hidden">
        {/* Main Content Area */}
        <main className="flex-1 overflow-y-auto p-4 sm:p-8">
          <div className="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
            {/* Left Column: Generator Form */}
            <div className="space-y-6">
              <div className="lg:hidden mb-4">
                {/* Mobile History Toggle hint if needed */}
              </div>
              <GeneratorForm
                onGenerate={handleGeneration}
                isLoading={isGenerating}
                hasToken={hasToken}
              />

              <div className="bg-blue-50 border border-blue-100 rounded-xl p-4 text-sm text-blue-800">
                <h4 className="font-semibold mb-1 flex items-center">
                  <svg className="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20"><path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clipRule="evenodd" /></svg>
                  Pro Tip
                </h4>
                <p>LinkedIn posts perform best when they tell a personal story connected to a professional lesson. Try the "Story" format!</p>
              </div>
            </div>

            {/* Right Column: Preview */}
            <div className="lg:sticky lg:top-8 h-fit">
              <LinkedInPreview
                post={currentPost}
                onRefine={handleRefine}
                isRefining={isRefining}
                linkedInProfile={linkedInUser}
              />
            </div>
          </div>
        </main>

        {/* Sidebar (Desktop: Static Right, Mobile: Slide-over) */}
        <div className={`fixed inset-y-0 right-0 z-30 w-80 bg-white shadow-xl transform transition-transform duration-300 ease-in-out ${sidebarOpen ? 'translate-x-0' : 'translate-x-full'}`}>
          <div className="flex items-center justify-between p-4 border-b">
            <h2 className="text-lg font-semibold">History</h2>
            <button onClick={() => setSidebarOpen(false)} className="text-gray-500 hover:text-gray-700">
              <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
          </div>
          <div className="h-full pb-20">
            <HistorySidebar history={history} onSelect={handleSelectHistory} selectedId={currentPost?.id} />
          </div>
        </div>

        {/* Overlay for mobile sidebar */}
        {sidebarOpen && (
          <div
            className="fixed inset-0 bg-black bg-opacity-25 z-20 lg:hidden"
            onClick={() => setSidebarOpen(false)}
          ></div>
        )}

        {/* Toggle Button for Desktop if sidebar closed (optional, but lets stick to nav button) */}
        {!sidebarOpen && (
          <button
            onClick={() => setSidebarOpen(true)}
            className="fixed right-0 top-1/2 transform -translate-y-1/2 bg-white p-3 rounded-l-lg shadow-md border border-r-0 border-gray-200 text-gray-500 hover:text-linkedin-blue z-10 hidden lg:block"
            title="View History"
          >
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          </button>
        )}
      </div>

      <ProfileModal
        isOpen={isProfileModalOpen}
        onClose={() => setIsProfileModalOpen(false)}
        onSave={handleSaveProfile}
        initialProfile={linkedInUser}
      />
    </div>
  );
};

export default App;
